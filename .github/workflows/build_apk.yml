name: Build Android APK

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.24.0'

    - name: Build APK (PYTHON FORCE INJECT)
      run: |
        # 1. Cria ambiente e instala Flet
        python -m venv venv
        source venv/bin/activate
        pip install --upgrade pip
        pip install flet==0.28.3

        # 2. SCRIPT DE INJE√á√ÉO DIRETA NO TEMPLATE
        # Esse script edita o arquivo .tar.gz original do Flet
        cat <<EOF > inject_perms.py
        import os
        import tarfile
        import sys
        import io

        # Permiss√µes que faltam no Flet
        PERMS = '''
        <uses-permission android:name="android.permission.ACCESS_FINE_LOCATION" />
        <uses-permission android:name="android.permission.ACCESS_COARSE_LOCATION" />
        '''

        # Localiza onde o Flet foi instalado no Linux
        import flet
        flet_dir = os.path.dirname(flet.__file__)
        print(f"üìç Diret√≥rio do Flet: {flet_dir}")

        # Procura o arquivo de template (o 'molde' do app Android)
        template_path = None
        for root, dirs, files in os.walk(flet_dir):
            for file in files:
                if file == "flutter_app_template.tar.gz":
                    template_path = os.path.join(root, file)
                    break
        
        if not template_path:
            print("‚ùå ERRO: Template do Flet n√£o encontrado!")
            sys.exit(1)
            
        print(f"üì¶ Modificando template em: {template_path}")

        # Abre o arquivo compactado, edita o XML na mem√≥ria e salva de volta
        temp_tar = template_path + ".temp"
        try:
            with tarfile.open(template_path, "r:gz") as read_tar:
                with tarfile.open(temp_tar, "w:gz") as write_tar:
                    for member in read_tar.getmembers():
                        # Se for o Manifesto Android, a gente edita
                        if "AndroidManifest.xml" in member.name and "src/main" in member.name:
                            print(f"üìù Injetando permiss√µes em: {member.name}")
                            f = read_tar.extractfile(member)
                            content = f.read().decode("utf-8")
                            
                            # Injeta as permiss√µes antes da tag <application>
                            if "ACCESS_FINE_LOCATION" not in content:
                                new_content = content.replace("<application", f"{PERMS}\n    <application")
                                encoded = new_content.encode("utf-8")
                                member.size = len(encoded)
                                write_tar.addfile(member, io.BytesIO(encoded))
                                print("‚úÖ SUCESSO: Permiss√µes inseridas!")
                            else:
                                print("‚ö†Ô∏è Permiss√µes j√° existiam.")
                                write_tar.addfile(member, io.BytesIO(content.encode("utf-8")))
                        else:
                            # Copia os outros arquivos sem mexer
                            if member.isfile():
                                write_tar.addfile(member, read_tar.extractfile(member))
                            else:
                                write_tar.addfile(member)
            
            # Substitui o arquivo original pelo nosso modificado
            os.replace(temp_tar, template_path)
            print("üéâ Template original do Flet atualizado!")

        except Exception as e:
            print(f"‚ùå Falha no script: {e}")
            sys.exit(1)
        EOF
        
        # Executa a modifica√ß√£o
        python inject_perms.py
        
        # 3. Agora faz o Build normal (que vai usar o template modificado)
        cd frontend
        printf "flet==0.28.3\nrequests\ncertifi\nurllib3\ncharset-normalizer\nidna\n" > requirements.txt
        flet build apk --verbose

    - name: Upload APK Artifact
      uses: actions/upload-artifact@v4
      with:
        name: vigiaa-release
        path: frontend/build/apk/app-release.apk