name: Build Android APK

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.24.0'

    - name: Build APK (V7 - Direto ao Ponto)
      run: |
        echo "üöÄ INICIANDO BUILD V7 (SEM BUSCA AUTOM√ÅTICA)"

        # 1. Configura Ambiente
        # Vamos criar o venv na raiz mesmo para garantir
        python -m venv venv
        source venv/bin/activate
        pip install --upgrade pip
        pip install flet==0.28.3

        # 2. OBRIGAR a entrada na pasta frontend
        # Se der erro aqui, √© porque a pasta n√£o chama 'frontend'
        echo "üìÇ Entrando na pasta frontend..."
        cd frontend 

        # 3. Prepara o Ca√ßador (Hunter Script) AQUI DENTRO
        cat <<EOF > hunter.sh
        #!/bin/bash
        echo "üèπ CA√áADOR V7: Procurando AndroidManifest..."
        for i in {1..300}; do
            # Procura apenas aqui dentro
            TARGET=\$(find . -name "AndroidManifest.xml" | grep "src/main/AndroidManifest.xml" | head -n 1)
            
            if [ -n "\$TARGET" ]; then
                echo "üéØ ALVO: \$TARGET"
                if grep -q "ACCESS_FINE_LOCATION" "\$TARGET"; then
                    echo "‚ö†Ô∏è J√° possui permiss√£o."
                else
                    echo "üíâ INJETANDO PERMISS√ïES..."
                    PERMS='<uses-permission android:name="android.permission.ACCESS_FINE_LOCATION" />\n<uses-permission android:name="android.permission.ACCESS_COARSE_LOCATION" />\n<uses-permission android:name="android.permission.INTERNET" />'
                    sed -i "s|<application|\$PERMS\n    <application|g" "\$TARGET"
                    echo "‚úÖ SUCESSO!"
                fi
            fi
            sleep 1
        done
        EOF
        
        chmod +x hunter.sh
        
        # 4. Dispara o Ca√ßador em Background
        ./hunter.sh &
        HUNTER_PID=$!
        
        # 5. Gera requirements e Roda o Build
        # O Flet precisa saber o que instalar
        printf "flet==0.28.3\nrequests\ncertifi\nurllib3\ncharset-normalizer\nidna\n" > requirements.txt
        
        echo "üöÄ Flet Build Iniciado na pasta FRONTEND..."
        flet build apk --verbose
        
        # Mata o ca√ßador
        kill $HUNTER_PID || true

    - name: Upload APK Artifact
      uses: actions/upload-artifact@v4
      with:
        # Nome √∫nico para garantir download novo
        name: vigiaa-release-FINAL-${{ github.run_number }}
        # O caminho agora √© direto dentro de frontend
        path: frontend/build/apk/app-release.apk