name: Build Android APK

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.24.0'

    - name: Build APK (V6 - O Ca√ßador Silencioso)
      run: |
        echo "üöÄ INICIANDO BUILD V6"

        # 1. Configura Ambiente
        python -m venv venv
        source venv/bin/activate
        pip install --upgrade pip
        pip install flet==0.28.3
        
        # 2. Prepara o Script Ca√ßador (Roda em paralelo)
        cat <<EOF > hunter.sh
        #!/bin/bash
        echo "üèπ CA√áADOR INICIADO: Procurando AndroidManifest.xml..."
        
        # Loop infinito que dura 300 segundos (5 min)
        for i in {1..300}; do
            # Procura o arquivo em qualquer lugar dentro da pasta atual e subpastas
            # O grep filtra para garantir que √© o arquivo principal do app
            TARGET=\$(find . -name "AndroidManifest.xml" | grep "src/main/AndroidManifest.xml" | head -n 1)
            
            if [ -n "\$TARGET" ]; then
                echo "üéØ ALVO ENCONTRADO EM: \$TARGET"
                
                # Verifica se j√° tem permiss√£o
                if grep -q "ACCESS_FINE_LOCATION" "\$TARGET"; then
                    echo "‚ö†Ô∏è O arquivo j√° tinha permiss√£o. Monitorando..."
                else
                    echo "üíâ INJETANDO PERMISS√ïES..."
                    PERMS='<uses-permission android:name="android.permission.ACCESS_FINE_LOCATION" />\n<uses-permission android:name="android.permission.ACCESS_COARSE_LOCATION" />\n<uses-permission android:name="android.permission.INTERNET" />'
                    sed -i "s|<application|\$PERMS\n    <application|g" "\$TARGET"
                    echo "‚úÖ SUCESSO! Permiss√µes gravadas."
                    # N√£o paramos o loop, pois o Flet pode recriar o arquivo.
                    # Continuamos vigiando para garantir.
                fi
            fi
            sleep 1
        done
        EOF
        
        chmod +x hunter.sh
        
        # 3. Encontra a pasta do projeto
        MAIN_PATH=$(find . -type f -name "main.py" -not -path "*/venv/*" | head -n 1)
        TARGET_DIR=$(dirname "$MAIN_PATH")
        echo "üìÇ Entrando na pasta: $TARGET_DIR"
        
        # Move o ca√ßador para a pasta correta e entra nela
        mv hunter.sh "$TARGET_DIR/"
        cd "$TARGET_DIR"

        # 4. DISPARA O CA√áADOR EM SEGUNDO PLANO (&)
        ./hunter.sh &
        HUNTER_PID=$!
        
        # 5. Roda o Build (Enquanto o ca√ßador trabalha)
        printf "flet==0.28.3\nrequests\ncertifi\nurllib3\ncharset-normalizer\nidna\n" > requirements.txt
        echo "üöÄ Iniciando Flet Build..."
        
        flet build apk --verbose
        
        # Mata o ca√ßador quando terminar
        kill $HUNTER_PID || true

    - name: Upload APK Artifact
      uses: actions/upload-artifact@v4
      with:
        name: vigiaa-release
        path: frontend/build/apk/app-release.apk