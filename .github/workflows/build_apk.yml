name: Build Android APK

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04 # VersÃ£o estÃ¡vel do Ubuntu (evita filas travadas)

    steps:
    - uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.24.0'

    - name: ConstruÃ§Ã£o Manual do APK (Com GPS Garantido)
      run: |
        echo "ğŸš€ INICIANDO BUILD MANUAL VIGIAA"

        # 1. InstalaÃ§Ã£o de DependÃªncias
        python -m venv venv
        source venv/bin/activate
        pip install --upgrade pip
        pip install flet==0.28.3

        # 2. Encontrar a pasta correta (Auto-NavegaÃ§Ã£o)
        MAIN_PATH=$(find . -type f -name "main.py" -not -path "*/venv/*" | head -n 1)
        if [ -z "$MAIN_PATH" ]; then
            echo "âŒ ERRO: main.py nÃ£o encontrado."
            exit 1
        fi
        TARGET_DIR=$(dirname "$MAIN_PATH")
        echo "ğŸ“‚ Entrando na pasta: $TARGET_DIR"
        cd "$TARGET_DIR"
        
        # 3. Gerar dependÃªncias
        printf "flet==0.28.3\nrequests\ncertifi\nurllib3\ncharset-normalizer\nidna\n" > requirements.txt

        # 4. GERAR O CÃ“DIGO NATIVO (Sem compilar ainda)
        # O flag --no-build apenas cria a pasta 'build/flutter'
        echo "âš™ï¸ Gerando projeto Flutter..."
        flet build apk --no-build --verbose

        # 5. INJEÃ‡ÃƒO CIRÃšRGICA DE PERMISSÃ•ES ğŸ’‰
        # Agora sabemos exatamente onde o arquivo estÃ¡
        MANIFEST="build/flutter/android/app/src/main/AndroidManifest.xml"
        
        if [ -f "$MANIFEST" ]; then
            echo "ğŸ¯ Manifesto encontrado para injeÃ§Ã£o!"
            
            # PermissÃµes que vamos injetar
            PERMS='<uses-permission android:name="android.permission.ACCESS_FINE_LOCATION" />\n<uses-permission android:name="android.permission.ACCESS_COARSE_LOCATION" />\n<uses-permission android:name="android.permission.INTERNET" />'
            
            # Usa o comando sed para inserir as permissÃµes antes da tag <application>
            sed -i "s|<application|$PERMS\n    <application|g" "$MANIFEST"
            
            echo "âœ… PermissÃµes injetadas com sucesso! Confira:"
            grep "uses-permission" "$MANIFEST"
        else
            echo "âŒ ERRO CRÃTICO: Manifesto nÃ£o gerado!"
            ls -R build
            exit 1
        fi

        # 6. COMPILAR O APK FINAL (Usando Flutter direto)
        echo "ğŸ”¨ Compilando APK final..."
        cd build/flutter
        flutter build apk --release

    - name: Upload APK Artifact
      uses: actions/upload-artifact@v4
      with:
        name: vigiaa-release
        # O caminho muda quando compilamos manualmente via Flutter
        path: frontend/build/flutter/build/app/outputs/flutter-apk/app-release.apk