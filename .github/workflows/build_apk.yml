name: Build Android APK

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.24.0'

    - name: Build APK (HACK DO TEMPLATE)
      run: |
        # 1. Configura ambiente
        python -m venv venv
        source venv/bin/activate
        pip install --upgrade pip
        pip install flet==0.28.3

        echo "üïµÔ∏è‚Äç‚ôÇÔ∏è INICIANDO CA√áADA AO ARQUIVO DE TEMPLATE..."
        
        # 2. A BUSCA IMPLAC√ÅVEL
        # Procura o arquivo .tar.gz em todo o diret√≥rio 'venv'
        TEMPLATE_PATH=$(find venv -name "flutter_app_template.tar.gz" -print -quit)
        
        if [ -z "$TEMPLATE_PATH" ]; then
            echo "‚ùå ERRO CR√çTICO: N√£o achei o template. Vou listar tudo para debug:"
            find venv -name "*.tar.gz"
            exit 1
        fi
        
        echo "‚úÖ ALVO LOCALIZADO: $TEMPLATE_PATH"
        
        # 3. O HACK (Python Cir√∫rgico)
        # Criamos um script que abre o zip, edita o XML l√° dentro e fecha o zip.
        cat <<EOF > hack_template.py
        import tarfile
        import io
        import os
        import sys

        target_path = "$TEMPLATE_PATH"
        temp_path = target_path + ".temp"
        
        # As permiss√µes que o Android exige
        PERMS = '''
        <uses-permission android:name="android.permission.ACCESS_FINE_LOCATION" />
        <uses-permission android:name="android.permission.ACCESS_COARSE_LOCATION" />
        '''

        print(f"üîß Abrindo arquivo: {target_path}")
        
        try:
            modified = False
            with tarfile.open(target_path, "r:gz") as read_tar:
                with tarfile.open(temp_path, "w:gz") as write_tar:
                    for member in read_tar.getmembers():
                        # Procura o Manifesto dentro do zip
                        if "AndroidManifest.xml" in member.name and "src/main" in member.name:
                            print(f"üìù Editando Manifesto: {member.name}")
                            f = read_tar.extractfile(member)
                            content = f.read().decode("utf-8")
                            
                            if "ACCESS_FINE_LOCATION" not in content:
                                # Injeta as permiss√µes antes da tag <application>
                                new_content = content.replace("<application", f"{PERMS}\n    <application")
                                encoded = new_content.encode("utf-8")
                                
                                member.size = len(encoded)
                                write_tar.addfile(member, io.BytesIO(encoded))
                                modified = True
                                print("üíâ Permiss√µes injetadas com sucesso!")
                            else:
                                print("‚ö†Ô∏è Permiss√µes j√° existiam.")
                                write_tar.addfile(member, io.BytesIO(content.encode("utf-8")))
                        else:
                            # Copia o resto dos arquivos sem mexer
                            if member.isfile():
                                write_tar.addfile(member, read_tar.extractfile(member))
                            else:
                                write_tar.addfile(member)
            
            if modified:
                os.replace(temp_path, target_path)
                print("üéâ SUCESSO: O template do Flet foi hackeado!")
            else:
                print("‚ÑπÔ∏è Nenhuma altera√ß√£o feita.")
                if os.path.exists(temp_path): os.remove(temp_path)

        except Exception as e:
            print(f"‚ùå Falha no script Python: {e}")
            sys.exit(1)
        EOF
        
        # Roda o hack
        python hack_template.py
        
        # 4. AGORA SIM, O BUILD
        cd frontend
        printf "flet==0.28.3\nrequests\ncertifi\nurllib3\ncharset-normalizer\nidna\n" > requirements.txt
        
        echo "üöÄ Iniciando Build do APK (usando template modificado)..."
        flet build apk --verbose

    - name: Upload APK Artifact
      uses: actions/upload-artifact@v4
      with:
        name: vigiaa-release
        path: frontend/build/apk/app-release.apk