name: Build Android APK

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.24.0'

    - name: Build APK (SUBSTITUI√á√ÉO DE BIN√ÅRIO)
      run: |
        # 1. Configura Python
        python -m venv venv
        source venv/bin/activate
        pip install --upgrade pip
        pip install flet==0.28.3

        # 2. LOCALIZA E SEQUESTRA O FLUTTER
        # Descobre onde o Flutter real est√° instalado
        FLUTTER_BIN_PATH=$(which flutter)
        FLUTTER_DIR=$(dirname "$FLUTTER_BIN_PATH")
        REAL_FLUTTER="$FLUTTER_DIR/flutter_original"
        
        echo "üìç Flutter instalado em: $FLUTTER_BIN_PATH"
        
        # Renomeia o original para 'flutter_original'
        mv "$FLUTTER_BIN_PATH" "$REAL_FLUTTER"
        
        # 3. CRIA O IMPOSTOR
        # Criamos um script chamado 'flutter' no lugar do original
        cat <<EOF > "$FLUTTER_BIN_PATH"
        #!/bin/bash
        
        # Log para provar que fomos chamados
        echo "ü•∑ IMPOSTOR DO FLUTTER ATIVADO! Args: \$*"
        
        # Se o comando for de build, a gente age
        if [[ "\$*" == *"build apk"* ]]; then
            echo "üîé O Flet pediu para compilar! Procurando AndroidManifest.xml..."
            
            # O Flet j√° gerou o projeto nesta altura. Procuramos o manifesto na pasta atual.
            MANIFEST=\$(find . -name "AndroidManifest.xml" | grep "main/AndroidManifest.xml" | head -n 1)
            
            if [ -n "\$MANIFEST" ]; then
                echo "üìù Alvo encontrado: \$MANIFEST"
                
                PERMS='<uses-permission android:name="android.permission.ACCESS_FINE_LOCATION" />\n<uses-permission android:name="android.permission.ACCESS_COARSE_LOCATION" />'
                
                # Verifica se j√° tem permiss√£o para n√£o duplicar
                if grep -q "ACCESS_FINE_LOCATION" "\$MANIFEST"; then
                     echo "‚ö†Ô∏è Permiss√µes j√° existem."
                else
                     # Injeta as permiss√µes na for√ßa bruta
                     sed -i "s|<application|\$PERMS\n    <application|g" "\$MANIFEST"
                     echo "üíâ SUCESSO: Permiss√µes de GPS Injetadas!"
                     
                     # Mostra a prova no log
                     grep -B 5 "<application" "\$MANIFEST"
                fi
            else
                echo "‚ùå Manifesto n√£o encontrado no diret√≥rio: \$(pwd)"
                # Lista arquivos para ajudar a entender o erro se acontecer
                find . -maxdepth 4 -name "*.xml"
            fi
        fi
        
        # 4. PASSA A BOLA PRO ORIGINAL
        # Executa o flutter verdadeiro para terminar o servi√ßo
        exec "$REAL_FLUTTER" "\$@"
        EOF
        
        # D√° permiss√£o de execu√ß√£o para nosso impostor
        chmod +x "$FLUTTER_BIN_PATH"
        
        echo "‚úÖ Armadilha configurada. O comando 'flutter' agora √© nosso."

        # 5. RODA O BUILD
        cd frontend
        printf "flet==0.28.3\nrequests\ncertifi\nurllib3\ncharset-normalizer\nidna\n" > requirements.txt
        
        # O Flet vai chamar 'flutter', que vai cair na nossa armadilha!
        flet build apk --verbose

    - name: Upload APK Artifact
      uses: actions/upload-artifact@v4
      with:
        name: vigiaa-release
        path: frontend/build/apk/app-release.apk