name: Build Android APK

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.24.0'

    - name: Build APK (FOR√áA BRUTA)
      run: |
        # 1. Cria e configura o ambiente virtual
        python -m venv venv
        
        # Ativa o venv (importante para o find achar as coisas no lugar certo)
        source venv/bin/activate
        
        pip install --upgrade pip
        pip install flet==0.28.3
        
        echo "üïµÔ∏è‚Äç‚ôÇÔ∏è Iniciando busca implac√°vel pelo template do Android..."
        
        # PROCURA O ARQUIVO COMPACTADO (O ESCONDERIJO PADR√ÉO)
        TEMPLATE_PATH=$(find ./venv -name "flutter_app_template.tar.gz" -print -quit)
        
        if [ -n "$TEMPLATE_PATH" ]; then
            echo "üì¶ Template compactado encontrado em: $TEMPLATE_PATH"
            
            # Cria √°rea de trabalho tempor√°ria
            mkdir -p temp_patch
            cd temp_patch
            
            # Abre o pacote
            tar -xzf "$TEMPLATE_PATH"
            
            # Acha o arquivo de manifesto l√° dentro
            MANIFEST=$(find . -name "AndroidManifest.xml" | grep "main/AndroidManifest.xml")
            
            if [ -n "$MANIFEST" ]; then
                echo "üìù Editando: $MANIFEST"
                
                # Injeta as permiss√µes
                PERMISSIONS='<uses-permission android:name="android.permission.ACCESS_FINE_LOCATION" />\n<uses-permission android:name="android.permission.ACCESS_COARSE_LOCATION" />'
                sed -i "s|<application|$PERMISSIONS\n    <application|g" "$MANIFEST"
                
                # Fecha o pacote de volta (com cuidado para manter a estrutura)
                # O '.' inclui arquivos ocultos e mant√©m a estrutura original
                tar -czf patched.tar.gz .
                
                # Substitui o original pelo nosso modificado
                mv patched.tar.gz "$TEMPLATE_PATH"
                echo "‚úÖ Template original substitu√≠do com sucesso!"
            else
                echo "‚ö†Ô∏è Manifest n√£o encontrado dentro do pacote. Isso √© estranho."
            fi
            
            # Limpa a bagun√ßa
            cd ..
            rm -rf temp_patch
            
        else
            echo "‚ö†Ô∏è Template .tar.gz n√£o encontrado. Procurando arquivos XML soltos..."
            
            # PROCURA O ARQUIVO SOLTO (CASO ESTEJA DESCOMPACTADO)
            MANIFEST_PATH=$(find ./venv -name "AndroidManifest.xml" | grep "main/AndroidManifest.xml" | head -n 1)
            
            if [ -n "$MANIFEST_PATH" ]; then
                 echo "üìù Patcheando arquivo solto: $MANIFEST_PATH"
                 PERMISSIONS='<uses-permission android:name="android.permission.ACCESS_FINE_LOCATION" />\n<uses-permission android:name="android.permission.ACCESS_COARSE_LOCATION" />'
                 sed -i "s|<application|$PERMISSIONS\n    <application|g" "$MANIFEST_PATH"
                 echo "‚úÖ Arquivo XML atualizado!"
            else
                 echo "‚ùå ERRO FATAL: N√£o foi poss√≠vel encontrar nem o template nem o manifesto."
                 echo "üìÇ Listando arquivos para debug:"
                 find ./venv -maxdepth 4
                 exit 1
            fi
        fi

        # AGORA SEGUE O BAILE NORMAL
        cd frontend
        
        printf "flet==0.28.3\nrequests\ncertifi\nurllib3\ncharset-normalizer\nidna\n" > requirements.txt
        
        flet build apk --verbose

    - name: Upload APK Artifact
      uses: actions/upload-artifact@v4
      with:
        name: vigiaa-release
        path: frontend/build/apk/app-release.apk